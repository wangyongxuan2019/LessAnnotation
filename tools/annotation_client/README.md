# LESS视频标注工具 - Windows客户端

用于Landing Error Scoring System (LESS) 评分的双视角视频标注工具。

## 功能特点

- **双视角同步播放**: 支持正面和侧面视频同步播放，视频窗口480x360
- **MediaPipe姿态检测**: 使用最新Tasks API实时检测33个关节点，计算关节角度
- **逐帧控制**: 精确的帧级控制，支持±1帧和±5帧移动
- **关键帧标注**: 开始帧、IC帧（初始触地）、MKF帧（最大屈膝）、结束帧标记
- **LESS 17项评分**: 评分面板位于右侧，一页内完成所有操作
- **文件夹管理**: 自动扫描文件夹结构，支持批量标注
- **自动切换**: 保存后自动切换到下一个视频
- **标注修改**: 支持重新加载已标注视频进行修改
- **浅色主题**: 清爽的Material Design风格界面

## 安装

1. 确保已安装Python 3.8+

2. 安装依赖:
```bash
cd tools/annotation_client
pip install -r requirements.txt
```

3. 首次运行时会自动下载MediaPipe模型文件(约4MB)

## 使用方法

### 启动程序

```bash
python main.py
```

### 操作流程

1. **选择文件夹**: 点击左侧"选择文件夹"按钮
   - 支持结构: `RecSync-Archive\s01\m01\e1\r0000\font1_xxx.mp4`
   - 自动识别front/side视频
   - 已标注的视频会显示"✓ 已标注"状态

2. **视频控制**:
   - ⏮/⏭: 快退/快进5帧
   - ◀/▶: 后退/前进1帧
   - 空格: 播放/暂停
   - 拖动进度条定位

3. **关键帧标注**:
   - 定位到开始帧 → 点击"标记"或按`S`
   - 定位到初始触地帧 → 点击"标记IC"或按`I`
   - 定位到最大屈膝帧 → 点击"标记MKF"或按`M`
   - 定位到结束帧 → 点击"标记"或按`E`

4. **LESS评分**: 右侧面板完成17项评分

5. **保存**: "保存并下一个"自动切换视频

6. **修改标注**: 双击已标注的视频即可重新加载并修改

## 快捷键

| 快捷键 | 功能 |
|--------|------|
| 空格 | 顺序标记关键帧 (开始帧→IC→MKF→结束帧) |
| P | 播放/暂停 |
| ← | 后退1帧 |
| → | 前进1帧 |
| S | 标记开始帧 |
| I | 标记IC帧 |
| M | 标记MKF帧 |
| E | 标记结束帧 |
| Ctrl+S | 保存 |

**提示**: 鼠标悬停在按钮或评分项上可查看详细说明。

## LESS 17项评分标准

### IC时刻 (Initial Contact) - 11项
| 项目 | 描述 | 评分 |
|------|------|------|
| A | 膝屈曲角度>30° | 0=是, 1=否 |
| B | 膝外翻(膝过中足) | 0=是, 1=否 |
| C | 躯干屈曲 | 0=屈曲, 1=未屈曲 |
| D | 躯干侧屈 | 0=垂直, 1=不垂直 |
| E | 踝跖屈(趾到跟) | 0=是, 1=否 |
| F | 足外旋>30° | 0=否, 1=是 |
| G | 足内旋>30° | 0=否, 1=是 |
| H | 站距<肩宽 | 0=否, 1=是 |
| I | 站距>肩宽 | 0=否, 1=是 |
| J | 双足对称着地 | 0=是, 1=否 |
| N | 髋屈曲 | 0=是, 1=否 |

### MKF时刻 (Max Knee Flexion) - 4项
| 项目 | 描述 | 评分 |
|------|------|------|
| K | 膝屈曲位移>45° | 0=是, 1=否 |
| L | 膝外翻位移 | 0=否, 1=是 |
| M | 躯干屈曲增加 | 0=是, 1=否 |
| O | 髋屈曲增加 | 0=是, 1=否 |

### 整体评分 - 2项
| 项目 | 描述 | 评分 |
|------|------|------|
| P | 矢状面关节位移 | 0=柔软, 1=中等, 2=僵硬 |
| Q | 整体印象 | 0=优秀, 1=中等, 2=较差 |

**总分范围: 0-19分** (分数越低越好)
- 0-4分: 优秀
- 5-6分: 良好
- ≥7分: 需要改进

程序实时计算并显示:
- **膝关节角度**: 髋-膝-踝三点角度
- **髋关节角度**: 肩-髋-膝三点角度
- **躯干角度**: 相对垂直线的倾斜

绿色关节点: 髋、膝、踝
紫色关节点: 其他关节

## 数据格式

### CSV
```csv
video_id,start_frame,ic_frame,mkf_frame,end_frame,item_A,item_B,...,item_Q,total_score,timestamp
```

### JSON
```json
{
  "annotations": [{
    "video_id": "s01_m01_e1_r0000",
    "keyframes": {"start": 100, "ic": 127, "mkf": 156, "end": 200},
    "scores": {"itemA": 0, "itemB": 1, ..., "itemQ": 1},
    "total_score": 8
  }]
}
```

## 技术说明

- **GUI**: PyQt5 + Material Design风格
- **视频**: OpenCV
- **姿态检测**: MediaPipe Tasks API (pose_landmarker)
- **模型**: pose_landmarker_lite (自动下载)

## 参考文档

- [MediaPipe Pose Landmarker Python Guide](https://ai.google.dev/edge/mediapipe/solutions/vision/pose_landmarker/python)
- [MediaPipe GitHub](https://github.com/google-ai-edge/mediapipe)
